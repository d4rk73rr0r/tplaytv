import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:intl/intl.dart';
import 'package:tplaytv/services/api_service.dart';
import 'package:tplaytv/main.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'phone_number_formatter.dart';
import 'package:tplaytv/utils/navigation.dart';

class AuthScreen extends StatefulWidget {
  const AuthScreen({super.key});

  @override
  State<AuthScreen> createState() => _AuthScreenState();
}

class _AuthScreenState extends State<AuthScreen> {
  final _phoneController = TextEditingController();
  final List<TextEditingController> _codeControllers = List.generate(
    4,
    (_) => TextEditingController(),
  );
  final _fullNameController = TextEditingController();
  final _usernameController = TextEditingController();

  // Fokus node lar
  final FocusNode _phoneFocusNode = FocusNode();
  final FocusNode _submitFocusNode = FocusNode();
  final FocusNode _switchAuthModeFocusNode = FocusNode();
  final List<FocusNode> _codeFocusNodes = List.generate(4, (_) => FocusNode());

  DateTime? _selectedBirthDate;
  bool _isLoginMode = true;
  bool _isCodeSent = false;
  bool _isLoading = false;
  String? _error;
  int? _selectedGender;
  int _remainingSeconds = 60;
  Timer? _timer;
  bool _canResend = false;

  @override
  void initState() {
    super.initState();
    // Dastlabki fokusni "Yuborish" tugmasiga qo'yish
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (mounted && context.mounted) {
        FocusScope.of(context).requestFocus(_submitFocusNode);
      }
    });
    // Fokus holatini kuzatish uchun debug
    _phoneFocusNode.addListener(() {
      debugPrint("Phone focus node: ${_phoneFocusNode.hasFocus}");
      setState(() {}); // Fokus o'zgarganda UI yangilanishi uchun
    });
    _submitFocusNode.addListener(() {
      debugPrint("Submit focus node: ${_submitFocusNode.hasFocus}");
      setState(() {}); // Fokus o'zgarganda UI yangilanishi uchun
    });
    _switchAuthModeFocusNode.addListener(() {
      debugPrint(
        "Switch auth mode focus node: ${_switchAuthModeFocusNode.hasFocus}",
      );
      setState(() {}); // Fokus o'zgarganda UI yangilanishi uchun
    });
    for (int i = 0; i < _codeFocusNodes.length; i++) {
      _codeFocusNodes[i].addListener(() {
        debugPrint("Code field $i focus: ${_codeFocusNodes[i].hasFocus}");
        if (_codeFocusNodes[i].hasFocus) {
          // Klaviaturani majburlab ochish
          SystemChannels.textInput.invokeMethod('TextInput.show');
        }
        setState(() {}); // Fokus o'zgarganda UI yangilanishi uchun
      });
    }
  }

  void _startTimer() {
    _remainingSeconds = 60;
    _canResend = false;
    _timer?.cancel();
    _timer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (_remainingSeconds > 0) {
        setState(() => _remainingSeconds--);
      } else {
        setState(() {
          _canResend = true;
          timer.cancel();
        });
      }
    });
  }

  bool _isPhoneValid() {
    final rawPhone = _phoneController.text.replaceAll(RegExp(r'[^0-9]'), '');
    return rawPhone.length == 9;
  }

  bool _isFormValid() {
    if (_isCodeSent) {
      return _codeControllers.every((c) => c.text.isNotEmpty);
    } else if (_isLoginMode) {
      return _isPhoneValid();
    } else {
      return _isPhoneValid() &&
          _fullNameController.text.isNotEmpty &&
          _usernameController.text.isNotEmpty &&
          _selectedBirthDate != null &&
          _selectedGender != null;
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        children: [
          Container(
            decoration: BoxDecoration(
              image: _tryLoadAssetImage('assets/images/background.png'),
            ),
          ),
          Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  Colors.black.withOpacity(0.3),
                  Colors.black.withOpacity(1.0),
                ],
              ),
            ),
          ),
          Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.only(top: 5, left: 40, right: 40),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.start,
                children: [
                  Padding(
                    padding: const EdgeInsets.only(bottom: 12),
                    child: _tryLoadAssetImageWidget(
                      'assets/images/logo.png',
                      height: 45,
                    ),
                  ),
                  Text(
                    _isCodeSent ? "Kodni kiriting" : "Raqamingizni kiriting",
                    style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      color: Colors.white,
                    ),
                  ),
                  const SizedBox(height: 12),
                  if (_isCodeSent) ...[
                    _buildCodeInputFields(),
                  ] else if (_isLoginMode) ...[
                    _buildPhoneField(),
                  ] else ...[
                    _buildPhoneField(),
                    const SizedBox(height: 10),
                    _buildTextField(
                      controller: _fullNameController,
                      label: "To'liq ism",
                    ),
                    const SizedBox(height: 10),
                    _buildTextField(
                      controller: _usernameController,
                      label: "Foydalanuvchi nomi",
                    ),
                    const SizedBox(height: 10),
                    _buildDatePicker(),
                    const SizedBox(height: 10),
                    _buildGenderDropdown(),
                  ],
                  if (_error != null) ...[
                    const SizedBox(height: 8),
                    Text(
                      _error!,
                      style: const TextStyle(
                        color: Colors.redAccent,
                        fontSize: 10,
                      ),
                    ),
                  ],
                  const SizedBox(height: 10),
                  Focus(
                    focusNode: _submitFocusNode,
                    canRequestFocus: true,
                    descendantsAreFocusable: true,
                    onFocusChange: (hasFocus) {
                      debugPrint("Submit button focus changed: $hasFocus");
                      setState(() {}); // Fokus o'zgarganda UI yangilanishi
                    },
                    onKey: (node, event) {
                      if (event is RawKeyDownEvent &&
                          event.logicalKey == LogicalKeyboardKey.select &&
                          _isFormValid() &&
                          !_isLoading) {
                        _handleAction();
                        debugPrint("Submit button activated via key event");
                        return KeyEventResult.handled;
                      }
                      return KeyEventResult.ignored;
                    },
                    child: Container(
                      decoration: BoxDecoration(
                        border:
                            _submitFocusNode.hasFocus
                                ? Border.all(color: Colors.yellow, width: 2)
                                : null, // Faqat fokuslanganda sariq ramka
                        borderRadius: BorderRadius.circular(10),
                      ),
                      child: ElevatedButton(
                        onPressed:
                            _isFormValid() && !_isLoading
                                ? _handleAction
                                : null,
                        style: ElevatedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 48,
                            vertical: 12,
                          ),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(10),
                          ),
                          backgroundColor: const Color(0xFFE91E63),
                          elevation: 6,
                        ),
                        child:
                            _isLoading
                                ? const SizedBox(
                                  width: 18,
                                  height: 18,
                                  child: CircularProgressIndicator(
                                    strokeWidth: 2,
                                    color: Colors.white,
                                  ),
                                )
                                : Text(
                                  _isCodeSent
                                      ? "Tasdiqlash ($_remainingSeconds)"
                                      : _canResend
                                      ? "Qayta yuborish"
                                      : "Yuborish",
                                  style: const TextStyle(
                                    fontSize: 12,
                                    color: Colors.white,
                                  ),
                                ),
                      ),
                    ),
                  ),
                  const SizedBox(height: 10),
                  if (!_isCodeSent)
                    Focus(
                      focusNode: _switchAuthModeFocusNode,
                      canRequestFocus: true,
                      descendantsAreFocusable: true,
                      onFocusChange: (hasFocus) {
                        debugPrint("Switch auth mode focus changed: $hasFocus");
                        setState(() {}); // Fokus o'zgarganda UI yangilanishi
                      },
                      onKey: (node, event) {
                        if (event is RawKeyDownEvent &&
                            event.logicalKey == LogicalKeyboardKey.select &&
                            !_isLoading) {
                          setState(() {
                            _isLoginMode = !_isLoginMode;
                            _resetFields();
                          });
                          debugPrint(
                            "Switch auth mode activated via key event",
                          );
                          return KeyEventResult.handled;
                        }
                        return KeyEventResult.ignored;
                      },
                      child: Container(
                        decoration: BoxDecoration(
                          border:
                              _switchAuthModeFocusNode.hasFocus
                                  ? Border.all(color: Colors.yellow, width: 2)
                                  : null, // Faqat fokuslanganda sariq ramka
                          borderRadius: BorderRadius.circular(10),
                        ),
                        child: TextButton(
                          onPressed:
                              _isLoading
                                  ? null
                                  : () => setState(() {
                                    _isLoginMode = !_isLoginMode;
                                    _resetFields();
                                  }),
                          child: Text(
                            _isLoginMode
                                ? "Ro'yxatdan o'tishni xohlaysizmi?"
                                : "Kirishni xohlaysizmi?",
                            style: const TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 10,
                            ),
                          ),
                        ),
                      ),
                    ),
                  if (!_isCodeSent) ...[
                    const SizedBox(height: 10),
                    Text(
                      "Agar raqamli klaviatura ko'rinmasa, qurilma sozlamalarida virtual klaviaturani faollashtiring.",
                      style: TextStyle(
                        color: Colors.white.withOpacity(0.7),
                        fontSize: 9,
                      ),
                      textAlign: TextAlign.center,
                    ),
                  ],
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  DecorationImage? _tryLoadAssetImage(String path) {
    try {
      return DecorationImage(
        image: AssetImage(path),
        fit: BoxFit.cover,
        opacity: 0.3,
      );
    } catch (e) {
      debugPrint("Rasm yuklashda xatolik: $e");
      return null;
    }
  }

  Widget _tryLoadAssetImageWidget(String path, {double? height}) {
    try {
      return Image.asset(path, height: height);
    } catch (e) {
      debugPrint("Rasm yuklashda xatolik: $e");
      return Container(
        height: height,
        color: Colors.grey,
        child: const Center(child: Text("Rasm topilmadi")),
      );
    }
  }

  Widget _buildPhoneField() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32),
      child: TextField(
        focusNode: _phoneFocusNode,
        controller: _phoneController,
        decoration: InputDecoration(
          prefixIcon: const Icon(Icons.phone, color: Colors.white),
          prefixText: "+998 ",
          prefixStyle: const TextStyle(
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
          hintText: "XX XXX XX XX",
          hintStyle: TextStyle(color: Colors.white.withOpacity(0.5)),
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: BorderSide.none, // Fokus bo'lmaganda ramka yo'q
          ),
          filled: true,
          fillColor: Colors.black.withOpacity(0.5),
          contentPadding: const EdgeInsets.symmetric(
            vertical: 12,
            horizontal: 16,
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: BorderSide(
              color:
                  _phoneFocusNode.hasFocus
                      ? Colors.yellow
                      : Colors.white.withOpacity(0.3),
              width: _phoneFocusNode.hasFocus ? 2 : 1,
            ),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: const BorderSide(color: Colors.yellow, width: 2),
          ),
        ),
        style: const TextStyle(color: Colors.white, fontSize: 12),
        keyboardType: TextInputType.number,
        inputFormatters: [PhoneNumberFormatter()],
        enabled: !_isLoading,
        onChanged: (value) {
          setState(() {});
        },
        onEditingComplete: () {
          if (_isPhoneValid()) {
            FocusScope.of(context).requestFocus(_submitFocusNode);
            debugPrint("Phone field editing complete, requesting submit focus");
          } else {
            FocusScope.of(context).requestFocus(_phoneFocusNode);
          }
        },
      ),
    );
  }

  Widget _buildCodeInputFields() {
    return Padding(
      padding: const EdgeInsets.only(top: 2),
      child: RawKeyboardListener(
        focusNode: FocusNode(),
        onKey: (RawKeyEvent event) {
          if (event is RawKeyDownEvent) {
            final currentFocusIndex = _codeFocusNodes.indexWhere(
              (node) => node.hasFocus,
            );
            if (currentFocusIndex == -1)
              return; // Hech qaysi maydon fokuslangan emas
            if (event.logicalKey == LogicalKeyboardKey.backspace &&
                _codeControllers[currentFocusIndex].text.isEmpty &&
                currentFocusIndex > 0) {
              FocusScope.of(
                context,
              ).requestFocus(_codeFocusNodes[currentFocusIndex - 1]);
              debugPrint(
                "Backspace pressed, moving to code field ${currentFocusIndex - 1}",
              );
            } else if (event.logicalKey == LogicalKeyboardKey.arrowLeft &&
                currentFocusIndex > 0) {
              FocusScope.of(
                context,
              ).requestFocus(_codeFocusNodes[currentFocusIndex - 1]);
              debugPrint(
                "ArrowLeft pressed, moving to code field ${currentFocusIndex - 1}",
              );
            } else if (event.logicalKey == LogicalKeyboardKey.arrowRight &&
                currentFocusIndex < 3) {
              FocusScope.of(
                context,
              ).requestFocus(_codeFocusNodes[currentFocusIndex + 1]);
              debugPrint(
                "ArrowRight pressed, moving to code field ${currentFocusIndex + 1}",
              );
            }
          }
        },
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: List.generate(4, (index) {
            return Padding(
              padding: const EdgeInsets.symmetric(horizontal: 8),
              child: SizedBox(
                width: 50,
                child: TextField(
                  focusNode: _codeFocusNodes[index],
                  controller: _codeControllers[index],
                  decoration: InputDecoration(
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(10),
                      borderSide:
                          BorderSide.none, // Fokus bo'lmaganda ramka yo'q
                    ),
                    filled: true,
                    fillColor: Colors.black.withOpacity(0.5),
                    counterText: "",
                    contentPadding: const EdgeInsets.symmetric(vertical: 10),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(10),
                      borderSide: BorderSide(
                        color:
                            _codeFocusNodes[index].hasFocus
                                ? Colors.yellow
                                : Colors.white.withOpacity(0.3),
                        width: _codeFocusNodes[index].hasFocus ? 2 : 1,
                      ),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(10),
                      borderSide: const BorderSide(
                        color: Colors.yellow,
                        width: 2,
                      ),
                    ),
                  ),
                  style: const TextStyle(color: Colors.white, fontSize: 12),
                  keyboardType: TextInputType.number,
                  textAlign: TextAlign.center,
                  maxLength: 1,
                  obscureText: true,
                  obscuringCharacter: '*',
                  enabled: !_isLoading,
                  onChanged: (value) {
                    debugPrint("Code field $index changed: $value");
                    if (value.isNotEmpty && index < 3) {
                      FocusScope.of(
                        context,
                      ).requestFocus(_codeFocusNodes[index + 1]);
                      debugPrint(
                        "Code field $index filled, moving to ${index + 1}",
                      );
                    } else if (value.isEmpty && index > 0) {
                      _codeControllers[index].clear();
                      FocusScope.of(
                        context,
                      ).requestFocus(_codeFocusNodes[index - 1]);
                      debugPrint(
                        "Code field $index cleared, moving to ${index - 1}",
                      );
                    }
                    if (index == 3 && value.isNotEmpty) {
                      FocusScope.of(context).requestFocus(_submitFocusNode);
                      debugPrint(
                        "Last code field filled, requesting submit focus",
                      );
                    }
                  },
                  onEditingComplete: () {
                    debugPrint("Code field $index editing complete");
                    if (index < 3 && _codeControllers[index].text.isNotEmpty) {
                      FocusScope.of(
                        context,
                      ).requestFocus(_codeFocusNodes[index + 1]);
                      debugPrint("Moving to code field ${index + 1}");
                    } else if (index == 3 &&
                        _codeControllers[index].text.isNotEmpty) {
                      _confirmCode();
                      debugPrint(
                        "Last code field editing complete, confirming code",
                      );
                    }
                  },
                ),
              ),
            );
          }),
        ),
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
  }) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32),
      child: TextField(
        controller: controller,
        decoration: InputDecoration(
          labelText: label,
          labelStyle: const TextStyle(color: Colors.white70, fontSize: 10),
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: BorderSide.none, // Fokus bo'lmaganda ramka yo'q
          ),
          filled: true,
          fillColor: Colors.black.withOpacity(0.5),
          contentPadding: const EdgeInsets.symmetric(
            vertical: 12,
            horizontal: 16,
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: BorderSide(
              color:
                  controller.text.isNotEmpty || controller.selection.isValid
                      ? Colors.yellow
                      : Colors.white.withOpacity(0.3),
              width:
                  controller.text.isNotEmpty || controller.selection.isValid
                      ? 2
                      : 1,
            ),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: const BorderSide(color: Colors.yellow, width: 2),
          ),
        ),
        style: const TextStyle(color: Colors.white, fontSize: 12),
        enabled: !_isLoading,
        onChanged: (value) {
          setState(() {}); // Matn o'zgarganda ramka yangilanishi uchun
        },
      ),
    );
  }

  Widget _buildDatePicker() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32),
      child: InkWell(
        onTap: _selectDate,
        child: Container(
          padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
          decoration: BoxDecoration(
            border: Border.all(color: Colors.white.withOpacity(0.3)),
            borderRadius: BorderRadius.circular(10),
            color: Colors.black.withOpacity(0.5),
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                _selectedBirthDate == null
                    ? "Tug'ilgan sanani tanlang"
                    : DateFormat('dd MMMM yyyy').format(_selectedBirthDate!),
                style: TextStyle(
                  color:
                      _selectedBirthDate == null
                          ? Colors.white70
                          : Colors.white,
                  fontSize: 12,
                ),
              ),
              const Icon(Icons.calendar_today, color: Colors.white, size: 18),
            ],
          ),
        ),
      ),
    );
  }

  Future<void> _selectDate() async {
    final pickedDate = await showDatePicker(
      context: context,
      initialDate: _selectedBirthDate ?? DateTime.now(),
      firstDate: DateTime(1900),
      lastDate: DateTime.now(),
      builder: (context, child) {
        return Theme(
          data: ThemeData.dark().copyWith(
            colorScheme: const ColorScheme.dark(
              primary: Color(0xFFE91E63),
              onPrimary: Colors.white,
              surface: Colors.black,
              onSurface: Colors.white,
            ),
            dialogTheme: const DialogTheme(backgroundColor: Colors.black),
          ),
          child: child!,
        );
      },
    );
    if (pickedDate != null) {
      setState(() => _selectedBirthDate = pickedDate);
    }
  }

  Widget _buildGenderDropdown() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32),
      child: DropdownButtonFormField<int>(
        value: _selectedGender,
        decoration: InputDecoration(
          labelText: "Jins",
          labelStyle: const TextStyle(color: Colors.white70, fontSize: 10),
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: BorderSide.none, // Fokus bo'lmaganda ramka yo'q
          ),
          filled: true,
          fillColor: Colors.black.withOpacity(0.5),
          contentPadding: const EdgeInsets.symmetric(
            vertical: 12,
            horizontal: 16,
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: BorderSide(
              color:
                  _selectedGender != null
                      ? Colors.yellow
                      : Colors.white.withOpacity(0.3),
              width: _selectedGender != null ? 2 : 1,
            ),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(10),
            borderSide: const BorderSide(color: Colors.yellow, width: 2),
          ),
        ),
        style: const TextStyle(color: Colors.white, fontSize: 12),
        dropdownColor: Colors.black,
        items: const [
          DropdownMenuItem(value: 1, child: Text("Erkak")),
          DropdownMenuItem(value: 0, child: Text("Ayol")),
        ],
        onChanged:
            _isLoading
                ? null
                : (value) => setState(() => _selectedGender = value),
      ),
    );
  }

  Future<void> _handleAction() async {
    debugPrint("Handle action called");
    if (_isCodeSent) {
      await _confirmCode();
    } else {
      await _sendPhone();
    }
  }

  Future<void> _sendPhone() async {
    debugPrint("Send phone called");
    final rawPhone = _phoneController.text.replaceAll(RegExp(r'[^0-9]'), '');
    final phone = "998$rawPhone";
    if (rawPhone.length != 9) {
      setState(() => _error = "To'liq raqam kiriting");
      return;
    }

    setState(() {
      _isLoading = true;
      _error = null;
    });

    final result = await ApiService.sendPhone(phone);

    if (!mounted) return;

    setState(() => _isLoading = false);

    if (result) {
      setState(() => _isCodeSent = true);
      _startTimer();
      // Birinchi kod maydoniga fokus o'tkazish
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (mounted && context.mounted) {
          FocusScope.of(context).requestFocus(_codeFocusNodes[0]);
          SystemChannels.textInput.invokeMethod('TextInput.show');
          debugPrint(
            "SMS sent, requesting focus on first code field and showing keyboard",
          );
        }
      });
    } else {
      setState(() => _error = "SMS yuborishda xatolik yuz berdi");
    }
  }

  Future<void> _confirmCode() async {
    debugPrint("Confirm code called");
    final code = _codeControllers.map((c) => c.text).join();
    if (code.length != 4) {
      setState(() => _error = "To'liq kod kiriting");
      return;
    }

    setState(() {
      _isLoading = true;
      _error = null;
    });

    final result = await ApiService.confirmSms(code);

    if (!mounted) return;

    setState(() => _isLoading = false);

    if (result['success']) {
      if (_isLoginMode) {
        _navigateToMainScreen();
      } else {
        await _registerUser();
      }
    } else if (result.containsKey('devices')) {
      _showDeviceSelectionDialog(result['devices']);
    } else {
      setState(() => _error = result['message'] ?? "Kod tasdiqlashda xatolik");
    }
  }

  Future<void> _showDeviceSelectionDialog(List<dynamic> devices) async {
    final prefs = await SharedPreferences.getInstance();
    final currentTokenId = prefs.getString('token_id');

    if (devices.length > 2) {
      setState(() => _isLoading = true);
      final tokenIdToKick =
          devices
              .firstWhere(
                (device) => device['id'].toString() != currentTokenId,
                orElse: () => devices.first,
              )['id']
              .toString();
      final kickResult = await ApiService.kickDevice(tokenIdToKick);

      if (!mounted) return;

      if (kickResult) {
        final confirmResult = await ApiService.confirmSms(
          _codeControllers.map((c) => c.text).join(),
        );
        setState(() => _isLoading = false);
        if (confirmResult['success']) {
          if (_isLoginMode) {
            _navigateToMainScreen();
          } else {
            await _registerUser();
          }
        } else {
          setState(() => _error = "Tasdiqlashda xatolik");
        }
      } else {
        setState(() {
          _isLoading = false;
          _error = "Qurilma o'chirishda xatolik";
        });
      }
      return;
    }

    showDialog(
      context: context,
      builder:
          (context) => AlertDialog(
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
            title: const Text("Bir nechta qurilma topildi"),
            content: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const Text("Bitta qurilmani o'chirib, davom eting:"),
                const SizedBox(height: 10),
                ...devices
                    .where(
                      (device) => device['id'].toString() != currentTokenId,
                    )
                    .map(
                      (device) => ListTile(
                        title: Text(device['device_name']),
                        subtitle: Text("ID: ${device['id'].toString()}"),
                        onTap: () async {
                          Navigator.pop(context);
                          setState(() => _isLoading = true);

                          final kickResult = await ApiService.kickDevice(
                            device['id'].toString(),
                          );
                          if (kickResult) {
                            final confirmResult = await ApiService.confirmSms(
                              _codeControllers.map((c) => c.text).join(),
                            );
                            setState(() => _isLoading = false);
                            if (confirmResult['success']) {
                              if (_isLoginMode) {
                                _navigateToMainScreen();
                              } else {
                                await _registerUser();
                              }
                            } else {
                              setState(() => _error = "Tasdiqlashda xatolik");
                            }
                          } else {
                            setState(() {
                              _isLoading = false;
                              _error = ("Qurilma o'chirishda xatolik");
                            });
                          }
                        },
                      ),
                    ),
              ],
            ),
          ),
    );
  }

  Future<void> _registerUser() async {
    debugPrint("Register user called");
    final fullName = _fullNameController.text;
    final username = _usernameController.text;
    if (fullName.isEmpty ||
        username.isEmpty ||
        _selectedBirthDate == null ||
        _selectedGender == null) {
      setState(() => _error = "Barcha maydonlarni to'ldiring");
      return;
    }

    setState(() {
      _isLoading = true;
      _error = null;
    });

    final prefs = await SharedPreferences.getInstance();
    final token = prefs.getString('auth_token') ?? '';
    final birthDateUnix = (_selectedBirthDate!.millisecondsSinceEpoch ~/ 1000);

    final result = await ApiService.updateUser(
      fullName: fullName,
      username: username,
      birthDate: birthDateUnix,
      sex: _selectedGender!,
      token: token,
    );

    if (!mounted) return;

    setState(() => _isLoading = false);

    if (result) {
      _navigateToMainScreen();
    } else {
      setState(() => _error = "Ro'yxatdan o'tishda xatolik yuz berdi");
    }
  }

  void _navigateToMainScreen() {
    debugPrint("Navigate to main screen");
    Navigator.pushReplacement(context, createSlideRoute(const MainScreen()));
  }

  void _resetFields() {
    debugPrint("Reset fields called");
    _error = null;
    _phoneController.clear();
    for (var controller in _codeControllers) controller.clear();
    _fullNameController.clear();
    _usernameController.clear();
    _selectedBirthDate = null;
    _selectedGender = null;
    _isCodeSent = false;
    _remainingSeconds = 60;
    _canResend = false;
    _timer?.cancel();
    // Fokusni qayta "Yuborish" tugmasiga qo'yish
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (mounted && context.mounted) {
        FocusScope.of(context).requestFocus(_submitFocusNode);
      }
    });
  }

  @override
  void dispose() {
    _phoneFocusNode.dispose();
    _submitFocusNode.dispose();
    _switchAuthModeFocusNode.dispose();
    for (var node in _codeFocusNodes) node.dispose();
    _phoneController.dispose();
    for (var controller in _codeControllers) controller.dispose();
    _fullNameController.dispose();
    _usernameController.dispose();
    _timer?.cancel();
    super.dispose();
  }
}

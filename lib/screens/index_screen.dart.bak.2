import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:palette_generator/palette_generator.dart';
import 'package:intl/intl.dart';
import 'dart:async';
import 'dart:ui';

class Movie {
  final String title;
  final String year;
  final String rating;
  final String imageUrl;
  final String category;

  Movie({
    required this.title,
    required this.year,
    required this.rating,
    required this.imageUrl,
    required this.category,
  });
}

class IndexScreen extends StatefulWidget {
  const IndexScreen({super.key});

  @override
  State<IndexScreen> createState() => _IndexScreenState();
}

class _IndexScreenState extends State<IndexScreen>
    with SingleTickerProviderStateMixin {
  bool _isMenuOpen = false;
  int _selectedMenuIndex = 0;
  int _selectedMovieIndex = 0;
  int _selectedSectionIndex = 0;
  int _selectedAppBarIndex = -1; // -1 = content, 0-4 = appbar buttons
  Color _backgroundColor = const Color(0xFF1a1a1a);
  late AnimationController _animationController;
  late Animation<Offset> _slideAnimation;
  Timer? _clockTimer;
  String _currentTime = '';
  String _currentDate = '';

  // Focus nodes
  final FocusNode _menuFocusNode = FocusNode();
  final FocusNode _contentFocusNode = FocusNode();
  final FocusNode _appBarFocusNode = FocusNode();

  // Scroll controllers
  late ScrollController _scrollController;
  final Map<int, ScrollController> _horizontalControllers = {};

  // Section keys for precise scrolling
  final GlobalKey _nowWatchingKey = GlobalKey();
  final GlobalKey _recommendedKey = GlobalKey();

  final List<String> _menuItems = [
    'Главная',
    'Лента',
    'Фильмы',
    'Мультфильмы',
    'Сериалы',
    'Персоны',
    'Каталог',
    'Фильтр',
    'Релизы',
    'Аниме',
    'Избранное',
    'История',
  ];

  final List<IconData> _menuIcons = [
    Icons.home_outlined,
    Icons.star_outline,
    Icons.movie_outlined,
    Icons.child_care_outlined,
    Icons.tv_outlined,
    Icons.people_outline,
    Icons.category_outlined,
    Icons.filter_alt_outlined,
    Icons.new_releases_outlined,
    Icons.animation_outlined,
    Icons.bookmark_border,
    Icons.history,
  ];

  final List<Movie> _nowWatchingMovies = List.generate(
    12,
    (i) => Movie(
      title: 'Фильм ${i + 1}',
      year: '2025',
      rating: (6.0 + (i % 5)).toStringAsFixed(1),
      imageUrl: 'https://picsum.photos/300/450?random=${i + 10}',
      category: 'Сейчас смотрят',
    ),
  );

  final List<Movie> _recommendedMovies = List.generate(
    15,
    (i) => Movie(
      title: 'Рекомендация ${i + 1}',
      year: '202${3 + i % 3}',
      rating: (7.0 + (i % 6) / 2).toStringAsFixed(1),
      imageUrl: 'https://picsum.photos/300/450?random=${i + 30}',
      category: 'Рекомендуем посмотреть',
    ),
  );

  List<List<Movie>> get _allSections => [
    _nowWatchingMovies,
    _recommendedMovies,
  ];

  @override
  void initState() {
    super.initState();
    _scrollController = ScrollController();

    _animationController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    _slideAnimation = Tween<Offset>(
      begin: const Offset(-1.0, 0.0),
      end: Offset.zero,
    ).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeInOut),
    );

    _updateDateTime();
    _clockTimer = Timer.periodic(
      const Duration(seconds: 1),
      (_) => _updateDateTime(),
    );

    // Initialize horizontal scroll controllers
    for (int i = 0; i < _allSections.length; i++) {
      _horizontalControllers[i] = ScrollController();
    }

    WidgetsBinding.instance.addPostFrameCallback((_) {
      _contentFocusNode.requestFocus();
      _updateBackgroundColor(0, 0);
    });
  }

  void _updateDateTime() {
    setState(() {
      final now = DateTime.now();
      _currentTime = DateFormat('HH:mm').format(now);
      _currentDate = DateFormat('dd MMMM yyyy\nEEEE', 'ru_RU').format(now);
    });
  }

  @override
  void dispose() {
    _animationController.dispose();
    _menuFocusNode.dispose();
    _contentFocusNode.dispose();
    _appBarFocusNode.dispose();
    _clockTimer?.cancel();
    _scrollController.dispose();
    for (final c in _horizontalControllers.values) {
      c.dispose();
    }
    super.dispose();
  }

  Future<void> _updateBackgroundColor(int sectionIndex, int movieIndex) async {
    final movie = _allSections[sectionIndex][movieIndex];
    try {
      final palette = await PaletteGenerator.fromImageProvider(
        NetworkImage(movie.imageUrl),
        maximumColorCount: 20,
      );
      if (mounted) {
        setState(() {
          _backgroundColor =
              palette.dominantColor?.color ?? const Color(0xFF1a1a1a);
        });
      }
    } catch (e) {
      debugPrint('Error generating palette: $e');
    }
  }

  void _toggleMenu() {
    setState(() {
      _isMenuOpen = !_isMenuOpen;
      if (_isMenuOpen) {
        _animationController.forward();
        _menuFocusNode.requestFocus();
      } else {
        _animationController.reverse();
        _contentFocusNode.requestFocus();
      }
    });
  }

  void _scrollToSection(int sectionIndex) {
    final key = sectionIndex == 0 ? _nowWatchingKey : _recommendedKey;
    final ctx = key.currentContext;
    if (ctx != null) {
      Scrollable.ensureVisible(
        ctx,
        duration: const Duration(milliseconds: 400),
        curve: Curves.easeInOut,
        alignment: 0.0,
      );
    }
  }

  void _scrollToCurrentItem() {
    final controller = _horizontalControllers[_selectedSectionIndex];
    if (controller == null || !controller.hasClients) return;

    const double itemWidth = 205.0; // 185 width + 20 margin
    final double viewportWidth = controller.position.viewportDimension;
    final double targetOffset =
        (_selectedMovieIndex * itemWidth) -
        (viewportWidth / 2) +
        (itemWidth / 2);

    final double maxOffset = controller.position.maxScrollExtent;
    final double clampedOffset = targetOffset.clamp(0.0, maxOffset);

    controller.animateTo(
      clampedOffset,
      duration: const Duration(milliseconds: 300),
      curve: Curves.easeOut,
    );
  }

  KeyEventResult _handleMenuKeyEvent(FocusNode node, KeyEvent event) {
    if (event is! KeyDownEvent) return KeyEventResult.ignored;

    if (event.logicalKey == LogicalKeyboardKey.arrowDown) {
      setState(() {
        _selectedMenuIndex = (_selectedMenuIndex + 1) % _menuItems.length;
      });
      return KeyEventResult.handled;
    }

    if (event.logicalKey == LogicalKeyboardKey.arrowUp) {
      setState(() {
        _selectedMenuIndex =
            (_selectedMenuIndex - 1 + _menuItems.length) % _menuItems.length;
      });
      return KeyEventResult.handled;
    }

    if (event.logicalKey == LogicalKeyboardKey.arrowRight ||
        event.logicalKey == LogicalKeyboardKey.goBack) {
      _toggleMenu();
      return KeyEventResult.handled;
    }

    if (event.logicalKey == LogicalKeyboardKey.select ||
        event.logicalKey == LogicalKeyboardKey.enter) {
      // Handle menu item selection
      debugPrint('Menu selected: ${_menuItems[_selectedMenuIndex]}');
      return KeyEventResult.handled;
    }

    return KeyEventResult.ignored;
  }

  KeyEventResult _handleContentKeyEvent(FocusNode node, KeyEvent event) {
    if (event is! KeyDownEvent) return KeyEventResult.ignored;

    if (event.logicalKey == LogicalKeyboardKey.arrowLeft) {
      if (_selectedMovieIndex == 0) {
        _toggleMenu();
        return KeyEventResult.handled;
      }
      setState(() {
        _selectedMovieIndex--;
        _updateBackgroundColor(_selectedSectionIndex, _selectedMovieIndex);
      });
      _scrollToCurrentItem();
      return KeyEventResult.handled;
    }

    if (event.logicalKey == LogicalKeyboardKey.arrowRight) {
      final maxIndex = _allSections[_selectedSectionIndex].length - 1;
      if (_selectedMovieIndex < maxIndex) {
        setState(() {
          _selectedMovieIndex++;
          _updateBackgroundColor(_selectedSectionIndex, _selectedMovieIndex);
        });
        _scrollToCurrentItem();
      }
      return KeyEventResult.handled;
    }

    if (event.logicalKey == LogicalKeyboardKey.arrowUp) {
      if (_selectedSectionIndex == 0) {
        // Go to AppBar
        setState(() {
          _selectedAppBarIndex = 0;
        });
        _appBarFocusNode.requestFocus();
        return KeyEventResult.handled;
      }
      setState(() {
        _selectedSectionIndex--;
        _selectedMovieIndex = 0;
        _updateBackgroundColor(_selectedSectionIndex, _selectedMovieIndex);
      });
      _scrollToSection(_selectedSectionIndex);
      _scrollToCurrentItem();
      return KeyEventResult.handled;
    }

    if (event.logicalKey == LogicalKeyboardKey.arrowDown) {
      if (_selectedSectionIndex < _allSections.length - 1) {
        setState(() {
          _selectedSectionIndex++;
          _selectedMovieIndex = 0;
          _updateBackgroundColor(_selectedSectionIndex, _selectedMovieIndex);
        });
        _scrollToSection(_selectedSectionIndex);
        _scrollToCurrentItem();
      }
      return KeyEventResult.handled;
    }

    if (event.logicalKey == LogicalKeyboardKey.select ||
        event.logicalKey == LogicalKeyboardKey.enter) {
      final movie = _allSections[_selectedSectionIndex][_selectedMovieIndex];
      debugPrint('Movie selected: ${movie.title}');
      return KeyEventResult.handled;
    }

    return KeyEventResult.ignored;
  }

  KeyEventResult _handleAppBarKeyEvent(FocusNode node, KeyEvent event) {
    if (event is! KeyDownEvent) return KeyEventResult.ignored;

    if (event.logicalKey == LogicalKeyboardKey.arrowLeft) {
      if (_selectedAppBarIndex > 0) {
        setState(() {
          _selectedAppBarIndex--;
        });
      }
      return KeyEventResult.handled;
    }

    if (event.logicalKey == LogicalKeyboardKey.arrowRight) {
      if (_selectedAppBarIndex < 4) {
        setState(() {
          _selectedAppBarIndex++;
        });
      }
      return KeyEventResult.handled;
    }

    if (event.logicalKey == LogicalKeyboardKey.arrowDown) {
      setState(() {
        _selectedAppBarIndex = -1;
      });
      _contentFocusNode.requestFocus();
      return KeyEventResult.handled;
    }

    if (event.logicalKey == LogicalKeyboardKey.select ||
        event.logicalKey == LogicalKeyboardKey.enter) {
      final buttons = [
        'Search',
        'Flash',
        'Notifications',
        'Settings',
        'Profile',
      ];
      debugPrint('AppBar button selected: ${buttons[_selectedAppBarIndex]}');
      return KeyEventResult.handled;
    }

    return KeyEventResult.ignored;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        children: [
          // Animated gradient background with blur
          AnimatedContainer(
            duration: const Duration(milliseconds: 600),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  _backgroundColor,
                  _backgroundColor.withOpacity(0.7),
                  Colors.black,
                ],
              ),
            ),
            child: BackdropFilter(
              filter: ImageFilter.blur(sigmaX: 80, sigmaY: 80),
              child: Container(color: Colors.black.withOpacity(0.1)),
            ),
          ),

          // Main content - slides right when menu opens
          AnimatedContainer(
            duration: const Duration(milliseconds: 300),
            curve: Curves.easeInOut,
            transform: Matrix4.translationValues(_isMenuOpen ? 280 : 0, 0, 0),
            child: Column(
              children: [
                // AppBar
                Focus(
                  focusNode: _appBarFocusNode,
                  onKeyEvent: _handleAppBarKeyEvent,
                  child: _buildAppBar(),
                ),
                // Content
                Expanded(
                  child: Focus(
                    focusNode: _contentFocusNode,
                    onKeyEvent: _handleContentKeyEvent,
                    child: SingleChildScrollView(
                      controller: _scrollController,
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const SizedBox(height: 20),
                          _buildMovieSection(
                            'Сейчас смотрят',
                            _nowWatchingMovies,
                            0,
                            _nowWatchingKey,
                          ),
                          const SizedBox(height: 50),
                          _buildMovieSection(
                            'Рекомендуем посмотреть',
                            _recommendedMovies,
                            1,
                            _recommendedKey,
                          ),
                          const SizedBox(height: 100),
                        ],
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),

          // Dark overlay when menu is open
          if (_isMenuOpen)
            Positioned.fill(
              left: 280,
              child: GestureDetector(
                onTap: _toggleMenu,
                child: Container(color: Colors.black.withOpacity(0.5)),
              ),
            ),

          // Sidebar menu
          SlideTransition(
            position: _slideAnimation,
            child: Container(
              width: 280,
              decoration: BoxDecoration(
                color: const Color(0xFF1c1c1e),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.5),
                    blurRadius: 20,
                    spreadRadius: 5,
                  ),
                ],
              ),
              child: Focus(
                focusNode: _menuFocusNode,
                onKeyEvent: _handleMenuKeyEvent,
                child: ListView.builder(
                  padding: const EdgeInsets.symmetric(vertical: 20),
                  itemCount: _menuItems.length,
                  itemBuilder: (context, i) {
                    final selected = _selectedMenuIndex == i;
                    return AnimatedContainer(
                      duration: const Duration(milliseconds: 200),
                      margin: const EdgeInsets.symmetric(
                        horizontal: 12,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        color:
                            selected
                                ? Colors.white.withOpacity(0.15)
                                : Colors.transparent,
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: ListTile(
                        leading: Icon(
                          _menuIcons[i],
                          color: selected ? Colors.cyanAccent : Colors.white70,
                          size: 24,
                        ),
                        title: Text(
                          _menuItems[i],
                          style: TextStyle(
                            color: selected ? Colors.white : Colors.white70,
                            fontSize: 16,
                            fontWeight:
                                selected ? FontWeight.w600 : FontWeight.normal,
                          ),
                        ),
                        onTap: () {
                          setState(() => _selectedMenuIndex = i);
                        },
                      ),
                    );
                  },
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildAppBar() {
    final appBarButtons = [
      Icons.search,
      Icons.flash_on,
      Icons.notifications_outlined,
      Icons.settings_outlined,
      Icons.account_circle,
    ];

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [Colors.black.withOpacity(0.7), Colors.transparent],
        ),
      ),
      child: Row(
        children: [
          const Icon(Icons.radar, size: 40, color: Colors.white),
          const SizedBox(width: 15),
          const Text(
            'Главная - TMDB',
            style: TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.w500,
              color: Colors.white,
            ),
          ),
          const Spacer(),
          ...List.generate(appBarButtons.length, (index) {
            final isSelected = _selectedAppBarIndex == index;
            return AnimatedContainer(
              duration: const Duration(milliseconds: 200),
              margin: const EdgeInsets.only(right: 10),
              decoration: BoxDecoration(
                border: Border.all(
                  color: isSelected ? Colors.cyanAccent : Colors.transparent,
                  width: 2,
                ),
                borderRadius: BorderRadius.circular(8),
                boxShadow:
                    isSelected
                        ? [
                          BoxShadow(
                            color: Colors.cyanAccent.withOpacity(0.5),
                            blurRadius: 15,
                            spreadRadius: 2,
                          ),
                        ]
                        : [],
              ),
              child: IconButton(
                icon: Icon(appBarButtons[index], size: index == 4 ? 32 : 28),
                color: isSelected ? Colors.cyanAccent : Colors.white,
                onPressed: () {},
              ),
            );
          }),
          const SizedBox(width: 20),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(
                _currentTime,
                style: const TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.w500,
                  color: Colors.white,
                ),
              ),
              Text(
                _currentDate.split('\n')[0],
                style: const TextStyle(fontSize: 12, color: Colors.white70),
              ),
              Text(
                _currentDate.split('\n')[1],
                style: const TextStyle(fontSize: 10, color: Colors.white60),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildMovieSection(
    String title,
    List<Movie> movies,
    int sectionIndex,
    GlobalKey key,
  ) {
    return Padding(
      key: key,
      padding: const EdgeInsets.symmetric(horizontal: 30),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                title,
                style: const TextStyle(
                  fontSize: 28,
                  fontWeight: FontWeight.w600,
                  color: Colors.white,
                ),
              ),
              if (title == 'Сейчас смотрят')
                TextButton(
                  onPressed: () {},
                  child: const Text(
                    'Еще',
                    style: TextStyle(fontSize: 16, color: Colors.white70),
                  ),
                ),
            ],
          ),
          const SizedBox(height: 20),
          SizedBox(
            height: 290,
            child: ListView.builder(
              controller: _horizontalControllers[sectionIndex],
              scrollDirection: Axis.horizontal,
              physics: const ClampingScrollPhysics(),
              itemCount: movies.length,
              itemBuilder: (context, index) {
                final movie = movies[index];
                final isSelected =
                    _selectedSectionIndex == sectionIndex &&
                    _selectedMovieIndex == index;

                return AnimatedContainer(
                  duration: const Duration(milliseconds: 200),
                  width: 185, // Increased width for 6 items on screen
                  margin: const EdgeInsets.only(right: 20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      AnimatedContainer(
                        duration: const Duration(milliseconds: 200),
                        height: 245,
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(
                            color:
                                isSelected
                                    ? Colors.cyanAccent
                                    : Colors.transparent,
                            width: 4,
                          ),
                          boxShadow:
                              isSelected
                                  ? [
                                    BoxShadow(
                                      color: Colors.cyanAccent.withOpacity(0.6),
                                      blurRadius: 20,
                                      spreadRadius: 4,
                                    ),
                                  ]
                                  : [
                                    BoxShadow(
                                      color: Colors.black.withOpacity(0.4),
                                      blurRadius: 10,
                                      offset: const Offset(0, 4),
                                    ),
                                  ],
                        ),
                        child: ClipRRect(
                          borderRadius: BorderRadius.circular(12),
                          child: Stack(
                            fit: StackFit.expand,
                            children: [
                              Image.network(
                                movie.imageUrl,
                                fit: BoxFit.cover,
                                errorBuilder:
                                    (context, _, __) => Container(
                                      color: Colors.grey[800],
                                      child: const Icon(
                                        Icons.movie,
                                        size: 60,
                                        color: Colors.grey,
                                      ),
                                    ),
                              ),
                              Positioned(
                                top: 10,
                                right: 10,
                                child: Container(
                                  padding: const EdgeInsets.symmetric(
                                    horizontal: 8,
                                    vertical: 4,
                                  ),
                                  decoration: BoxDecoration(
                                    color: Colors.black.withOpacity(0.75),
                                    borderRadius: BorderRadius.circular(6),
                                  ),
                                  child: Text(
                                    movie.rating,
                                    style: const TextStyle(
                                      color: Colors.white,
                                      fontSize: 14,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        movie.title,
                        style: TextStyle(
                          color: isSelected ? Colors.white : Colors.white70,
                          fontSize: 14,
                          fontWeight:
                              isSelected ? FontWeight.w600 : FontWeight.normal,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                      Text(
                        movie.year,
                        style: const TextStyle(
                          color: Colors.white60,
                          fontSize: 12,
                        ),
                      ),
                    ],
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

import 'dart:async';
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:intl/intl.dart';
import 'package:tplaytv/services/api_service.dart';
import 'package:tplaytv/main.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'phone_number_formatter.dart';
import 'package:tplaytv/utils/navigation.dart';

class AuthScreen extends StatefulWidget {
  const AuthScreen({super.key});

  @override
  State<AuthScreen> createState() => _AuthScreenState();
}

class _AuthScreenState extends State<AuthScreen> with TickerProviderStateMixin {
  final _phoneController = TextEditingController();
  final List<TextEditingController> _codeControllers = List.generate(
    4,
    (_) => TextEditingController(),
  );
  final _fullNameController = TextEditingController();
  final _usernameController = TextEditingController();

  final FocusNode _phoneFocusNode = FocusNode();
  final FocusNode _submitFocusNode = FocusNode();
  final FocusNode _switchAuthModeFocusNode = FocusNode();
  final List<FocusNode> _codeFocusNodes = List.generate(4, (_) => FocusNode());
  final FocusNode _fullNameFocusNode = FocusNode();
  final FocusNode _usernameFocusNode = FocusNode();
  final FocusNode _datePickerFocusNode = FocusNode();
  final FocusNode _genderFocusNode = FocusNode();
  final FocusNode _phoneRawKeyFocusNode = FocusNode(canRequestFocus: false);
  final FocusNode _codeRawKeyFocusNode = FocusNode();

  DateTime? _selectedBirthDate;
  bool _isLoginMode = true;
  bool _isCodeSent = false;
  bool _isLoading = false;
  String? _error;
  int? _selectedGender;
  int _remainingSeconds = 60;
  Timer? _timer;
  bool _canResend = false;

  late AnimationController _fadeController;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();
    _fadeController = AnimationController(
      duration: const Duration(milliseconds: 800),
      vsync: this,
    );
    _fadeAnimation = CurvedAnimation(
      parent: _fadeController,
      curve: Curves.easeInOut,
    );
    _fadeController.forward();

    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (mounted && context.mounted) {
        FocusScope.of(context).requestFocus(_submitFocusNode);
      }
    });

    _phoneFocusNode.addListener(_onPhoneFieldFocusChanged);
    _addFocusListeners();
    _startTimerIfNeeded();
  }

  void _onPhoneFieldFocusChanged() {
    if (_phoneFocusNode.hasFocus && mounted) {
      Future.delayed(const Duration(milliseconds: 120), () {
        if (mounted && _phoneFocusNode.hasFocus) {
          SystemChannels.textInput.invokeMethod('TextInput.show');
        }
      });
    }
    setState(() {});
  }

  void _addFocusListeners() {
    final focusNodes = [
      _submitFocusNode,
      _switchAuthModeFocusNode,
      ..._codeFocusNodes,
      _fullNameFocusNode,
      _usernameFocusNode,
      _datePickerFocusNode,
      _genderFocusNode,
    ];
    for (var node in focusNodes) {
      node.addListener(() => setState(() {}));
    }
  }

  void _startTimerIfNeeded() {
    if (_isCodeSent) _startTimer();
  }

  void _startTimer() {
    _remainingSeconds = 60;
    _canResend = false;
    _timer?.cancel();
    _timer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (_remainingSeconds > 0) {
        setState(() => _remainingSeconds--);
      } else {
        setState(() {
          _canResend = true;
          timer.cancel();
        });
      }
    });
  }

  bool _isPhoneValid() {
    final rawPhone = _phoneController.text.replaceAll(RegExp(r'[^0-9]'), '');
    return rawPhone.length == 9;
  }

  bool _isFormValid() {
    if (_isCodeSent) {
      return _codeControllers.every((c) => c.text.isNotEmpty);
    } else if (_isLoginMode) {
      return _isPhoneValid();
    } else {
      return _isPhoneValid() &&
          _fullNameController.text.isNotEmpty &&
          _usernameController.text.isNotEmpty &&
          _selectedBirthDate != null &&
          _selectedGender != null;
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        children: [
          // Animated gradient background
          AnimatedContainer(
            duration: const Duration(seconds: 3),
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  Color(0xFF1a1a2e),
                  Color(0xFF16213e),
                  Color(0xFF0f3460),
                  Color(0xFF533483),
                ],
                stops: [0.0, 0.3, 0.6, 1.0],
              ),
            ),
          ),

          // Animated circles
          ...List.generate(3, (index) {
            return Positioned(
              top: 100.0 * index - 50,
              right: -100.0 * index,
              child: Container(
                width: 300,
                height: 300,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  gradient: RadialGradient(
                    colors: [
                      Colors.purple.withOpacity(0.1),
                      Colors.transparent,
                    ],
                  ),
                ),
              ),
            );
          }),

          // Main content
          FadeTransition(
            opacity: _fadeAnimation,
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 60, vertical: 30),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  // Logo section - chap tomonda
                  Expanded(
                    flex: 2,
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Container(
                          padding: const EdgeInsets.all(16),
                          decoration: BoxDecoration(
                            shape: BoxShape.circle,
                            gradient: RadialGradient(
                              colors: [
                                const Color(0xFFe94560).withOpacity(0.3),
                                Colors.transparent,
                              ],
                            ),
                          ),
                          child: _tryLoadAssetImageWidget(
                            'assets/images/logo.png',
                            height: 60,
                          ),
                        ),
                        const SizedBox(height: 20),
                        ShaderMask(
                          shaderCallback:
                              (bounds) => const LinearGradient(
                                colors: [Color(0xFFe94560), Color(0xFFf72585)],
                              ).createShader(bounds),
                          child: Text(
                            _isCodeSent ? "Tasdiqlash" : "Xush kelibsiz",
                            style: const TextStyle(
                              fontSize: 28,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                        ),
                        const SizedBox(height: 8),
                        Text(
                          _isCodeSent ? "SMS kodni kiriting" : "Kirish uchun",
                          style: TextStyle(
                            fontSize: 14,
                            color: Colors.white.withOpacity(0.6),
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(width: 40),

                  // Main form section
                  Expanded(
                    flex: 3,
                    child: SingleChildScrollView(
                      child: Container(
                        constraints: const BoxConstraints(maxWidth: 550),
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(24),
                          gradient: LinearGradient(
                            begin: Alignment.topLeft,
                            end: Alignment.bottomRight,
                            colors: [
                              Colors.white.withOpacity(0.1),
                              Colors.white.withOpacity(0.05),
                            ],
                          ),
                          border: Border.all(
                            color: Colors.white.withOpacity(0.2),
                            width: 1.5,
                          ),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withOpacity(0.3),
                              blurRadius: 30,
                              offset: const Offset(0, 15),
                            ),
                          ],
                        ),
                        child: ClipRRect(
                          borderRadius: BorderRadius.circular(24),
                          child: BackdropFilter(
                            filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                            child: Padding(
                              padding: const EdgeInsets.all(32),
                              child: Column(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  if (_isCodeSent)
                                    _buildCodeInputFields()
                                  else if (_isLoginMode)
                                    _buildPhoneField()
                                  else ...[
                                    _buildPhoneField(),
                                    const SizedBox(height: 20),
                                    _buildTextField(
                                      controller: _fullNameController,
                                      focusNode: _fullNameFocusNode,
                                      label: "To'liq ism",
                                      icon: Icons.person_outline,
                                    ),
                                    const SizedBox(height: 20),
                                    _buildTextField(
                                      controller: _usernameController,
                                      focusNode: _usernameFocusNode,
                                      label: "Foydalanuvchi nomi",
                                      icon: Icons.alternate_email,
                                    ),
                                    const SizedBox(height: 20),
                                    _buildDatePicker(),
                                    const SizedBox(height: 20),
                                    _buildGenderDropdown(),
                                  ],
                                  if (_error != null) ...[
                                    const SizedBox(height: 20),
                                    Container(
                                      padding: const EdgeInsets.all(14),
                                      decoration: BoxDecoration(
                                        color: Colors.red.withOpacity(0.2),
                                        borderRadius: BorderRadius.circular(14),
                                        border: Border.all(
                                          color: Colors.red.withOpacity(0.5),
                                        ),
                                      ),
                                      child: Row(
                                        children: [
                                          const Icon(
                                            Icons.error_outline,
                                            color: Colors.redAccent,
                                            size: 20,
                                          ),
                                          const SizedBox(width: 10),
                                          Expanded(
                                            child: Text(
                                              _error!,
                                              style: const TextStyle(
                                                color: Colors.redAccent,
                                                fontSize: 14,
                                              ),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                  ],
                                  const SizedBox(height: 24),
                                  _buildGradientButton(),
                                  const SizedBox(height: 16),
                                  if (!_isCodeSent) _buildSwitchButton(),
                                  if (!_isCodeSent) ...[
                                    const SizedBox(height: 16),
                                    Row(
                                      mainAxisAlignment:
                                          MainAxisAlignment.center,
                                      children: [
                                        Icon(
                                          Icons.info_outline,
                                          color: Colors.white.withOpacity(0.5),
                                          size: 16,
                                        ),
                                        const SizedBox(width: 8),
                                        Flexible(
                                          child: Text(
                                            "Klaviatura yoqish: Sozlamalar",
                                            style: TextStyle(
                                              color: Colors.white.withOpacity(
                                                0.5,
                                              ),
                                              fontSize: 12,
                                            ),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ],
                                ],
                              ),
                            ),
                          ),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildGradientButton() {
    return Focus(
      focusNode: _submitFocusNode,
      canRequestFocus: true,
      onFocusChange: (hasFocus) => setState(() {}),
      onKey: (node, event) {
        if (event is RawKeyDownEvent &&
            event.logicalKey == LogicalKeyboardKey.select &&
            _isFormValid() &&
            !_isLoading) {
          _handleAction();
          return KeyEventResult.handled;
        }
        return KeyEventResult.ignored;
      },
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          gradient:
              _submitFocusNode.hasFocus
                  ? const LinearGradient(
                    colors: [Color(0xFFf72585), Color(0xFFe94560)],
                  )
                  : null,
          boxShadow:
              _submitFocusNode.hasFocus
                  ? [
                    BoxShadow(
                      color: const Color(0xFFe94560).withOpacity(0.6),
                      blurRadius: 20,
                      spreadRadius: 2,
                    ),
                  ]
                  : [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.3),
                      blurRadius: 10,
                    ),
                  ],
          border:
              _submitFocusNode.hasFocus
                  ? Border.all(color: Colors.white.withOpacity(0.5), width: 2)
                  : null,
        ),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            borderRadius: BorderRadius.circular(16),
            onTap: _isFormValid() && !_isLoading ? _handleAction : null,
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 40, vertical: 16),
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                gradient:
                    !_submitFocusNode.hasFocus
                        ? LinearGradient(
                          colors: [
                            const Color(0xFFe94560).withOpacity(0.8),
                            const Color(0xFFf72585).withOpacity(0.8),
                          ],
                        )
                        : null,
              ),
              child:
                  _isLoading
                      ? const SizedBox(
                        width: 20,
                        height: 20,
                        child: CircularProgressIndicator(
                          strokeWidth: 2.5,
                          color: Colors.white,
                        ),
                      )
                      : Row(
                        mainAxisSize: MainAxisSize.min,
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            _isCodeSent
                                ? Icons.check_circle_outline
                                : Icons.arrow_forward,
                            color: Colors.white,
                            size: 20,
                          ),
                          const SizedBox(width: 10),
                          Text(
                            _isCodeSent
                                ? "Tasdiqlash ($_remainingSeconds)"
                                : _canResend
                                ? "Qayta yuborish"
                                : "Davom etish",
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ],
                      ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildSwitchButton() {
    return Focus(
      focusNode: _switchAuthModeFocusNode,
      onFocusChange: (hasFocus) => setState(() {}),
      onKey: (node, event) {
        if (event is RawKeyDownEvent &&
            event.logicalKey == LogicalKeyboardKey.select &&
            !_isLoading) {
          setState(() {
            _isLoginMode = !_isLoginMode;
            _resetFields();
          });
          return KeyEventResult.handled;
        }
        return KeyEventResult.ignored;
      },
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color:
                _switchAuthModeFocusNode.hasFocus
                    ? Colors.white.withOpacity(0.5)
                    : Colors.white.withOpacity(0.2),
            width: 2,
          ),
          boxShadow:
              _switchAuthModeFocusNode.hasFocus
                  ? [
                    BoxShadow(
                      color: Colors.white.withOpacity(0.2),
                      blurRadius: 15,
                    ),
                  ]
                  : null,
        ),
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            borderRadius: BorderRadius.circular(16),
            onTap:
                _isLoading
                    ? null
                    : () => setState(() {
                      _isLoginMode = !_isLoginMode;
                      _resetFields();
                    }),
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 14),
              child: Text(
                _isLoginMode ? "Ro'yxatdan o'tish" : "Kirish",
                style: TextStyle(
                  color: Colors.white.withOpacity(0.9),
                  fontSize: 14,
                  fontWeight: FontWeight.w500,
                ),
                textAlign: TextAlign.center,
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildPhoneField() {
    return RawKeyboardListener(
      focusNode: _phoneRawKeyFocusNode,
      onKey: (RawKeyEvent event) {
        if (event is! RawKeyDownEvent) return;
        final key = event.logicalKey;
        if (key == LogicalKeyboardKey.goBack) {
          SystemChannels.textInput.invokeMethod('TextInput.hide');
          final rawPhone = _phoneController.text.replaceAll(
            RegExp(r'[^0-9]'),
            '',
          );
          if (rawPhone.isEmpty && mounted) {
            FocusScope.of(context).requestFocus(_submitFocusNode);
          }
        }
        if (key == LogicalKeyboardKey.select) {
          SystemChannels.textInput.invokeMethod('TextInput.show');
        }
        if (key == LogicalKeyboardKey.arrowDown) {
          final nextFocus =
              _isLoginMode ? _submitFocusNode : _fullNameFocusNode;
          FocusScope.of(context).requestFocus(nextFocus);
        }
      },
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          gradient: LinearGradient(
            colors: [
              Colors.white.withOpacity(0.1),
              Colors.white.withOpacity(0.05),
            ],
          ),
          border: Border.all(
            color:
                _phoneFocusNode.hasFocus
                    ? const Color(0xFFe94560)
                    : Colors.white.withOpacity(0.2),
            width: 2,
          ),
          boxShadow:
              _phoneFocusNode.hasFocus
                  ? [
                    BoxShadow(
                      color: const Color(0xFFe94560).withOpacity(0.3),
                      blurRadius: 15,
                    ),
                  ]
                  : null,
        ),
        child: TextField(
          focusNode: _phoneFocusNode,
          controller: _phoneController,
          decoration: InputDecoration(
            prefixIcon: Container(
              margin: const EdgeInsets.all(10),
              padding: const EdgeInsets.all(6),
              decoration: BoxDecoration(
                color: const Color(0xFFe94560).withOpacity(0.2),
                borderRadius: BorderRadius.circular(10),
              ),
              child: const Icon(
                Icons.phone_android,
                color: Color(0xFFe94560),
                size: 20,
              ),
            ),
            prefixText: "+998 ",
            prefixStyle: const TextStyle(
              fontWeight: FontWeight.bold,
              color: Colors.white,
              fontSize: 16,
            ),
            hintText: "XX XXX XX XX",
            hintStyle: TextStyle(
              color: Colors.white.withOpacity(0.3),
              fontSize: 16,
            ),
            border: InputBorder.none,
            contentPadding: const EdgeInsets.symmetric(
              vertical: 16,
              horizontal: 16,
            ),
          ),
          style: const TextStyle(
            color: Colors.white,
            fontSize: 16,
            letterSpacing: 1,
          ),
          keyboardType: TextInputType.number,
          inputFormatters: [PhoneNumberFormatter()],
          enabled: !_isLoading,
          onChanged: (_) => setState(() {}),
          onEditingComplete: () {
            if (_isPhoneValid()) {
              FocusScope.of(context).requestFocus(_submitFocusNode);
            }
          },
        ),
      ),
    );
  }

  Widget _buildCodeInputFields() {
    return RawKeyboardListener(
      focusNode: _codeRawKeyFocusNode,
      onKey: (RawKeyEvent event) {
        if (event is RawKeyDownEvent) {
          final currentFocusIndex = _codeFocusNodes.indexWhere(
            (node) => node.hasFocus,
          );
          if (currentFocusIndex == -1) return;
          if (event.logicalKey == LogicalKeyboardKey.backspace &&
              _codeControllers[currentFocusIndex].text.isEmpty &&
              currentFocusIndex > 0) {
            FocusScope.of(
              context,
            ).requestFocus(_codeFocusNodes[currentFocusIndex - 1]);
          } else if (event.logicalKey == LogicalKeyboardKey.arrowLeft &&
              currentFocusIndex > 0) {
            FocusScope.of(
              context,
            ).requestFocus(_codeFocusNodes[currentFocusIndex - 1]);
          } else if (event.logicalKey == LogicalKeyboardKey.arrowRight &&
              currentFocusIndex < 3) {
            FocusScope.of(
              context,
            ).requestFocus(_codeFocusNodes[currentFocusIndex + 1]);
          }
        }
      },
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: List.generate(4, (index) {
          return Padding(
            padding: const EdgeInsets.symmetric(horizontal: 6),
            child: AnimatedContainer(
              duration: const Duration(milliseconds: 200),
              width: 60,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(14),
                gradient: LinearGradient(
                  colors: [
                    Colors.white.withOpacity(0.1),
                    Colors.white.withOpacity(0.05),
                  ],
                ),
                border: Border.all(
                  color:
                      _codeFocusNodes[index].hasFocus
                          ? const Color(0xFFe94560)
                          : Colors.white.withOpacity(0.2),
                  width: 2,
                ),
                boxShadow:
                    _codeFocusNodes[index].hasFocus
                        ? [
                          BoxShadow(
                            color: const Color(0xFFe94560).withOpacity(0.3),
                            blurRadius: 15,
                          ),
                        ]
                        : null,
              ),
              child: TextField(
                focusNode: _codeFocusNodes[index],
                controller: _codeControllers[index],
                decoration: const InputDecoration(
                  border: InputBorder.none,
                  counterText: "",
                  contentPadding: EdgeInsets.symmetric(vertical: 16),
                ),
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                ),
                keyboardType: TextInputType.number,
                textAlign: TextAlign.center,
                maxLength: 1,
                obscureText: true,
                obscuringCharacter: 'â—',
                enabled: !_isLoading,
                onChanged: (value) {
                  if (value.isNotEmpty && index < 3) {
                    FocusScope.of(
                      context,
                    ).requestFocus(_codeFocusNodes[index + 1]);
                  } else if (value.isEmpty && index > 0) {
                    _codeControllers[index].clear();
                    FocusScope.of(
                      context,
                    ).requestFocus(_codeFocusNodes[index - 1]);
                  }
                  if (index == 3 && value.isNotEmpty) {
                    FocusScope.of(context).requestFocus(_submitFocusNode);
                  }
                  setState(() {});
                },
                onEditingComplete: () {
                  if (index < 3 && _codeControllers[index].text.isNotEmpty) {
                    FocusScope.of(
                      context,
                    ).requestFocus(_codeFocusNodes[index + 1]);
                  } else if (index == 3 &&
                      _codeControllers[index].text.isNotEmpty) {
                    _confirmCode();
                  }
                },
              ),
            ),
          );
        }),
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required FocusNode focusNode,
    required String label,
    required IconData icon,
  }) {
    return AnimatedContainer(
      duration: const Duration(milliseconds: 200),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        gradient: LinearGradient(
          colors: [
            Colors.white.withOpacity(0.1),
            Colors.white.withOpacity(0.05),
          ],
        ),
        border: Border.all(
          color:
              focusNode.hasFocus
                  ? const Color(0xFFe94560)
                  : Colors.white.withOpacity(0.2),
          width: 2,
        ),
        boxShadow:
            focusNode.hasFocus
                ? [
                  BoxShadow(
                    color: const Color(0xFFe94560).withOpacity(0.3),
                    blurRadius: 15,
                  ),
                ]
                : null,
      ),
      child: TextField(
        focusNode: focusNode,
        controller: controller,
        decoration: InputDecoration(
          prefixIcon: Container(
            margin: const EdgeInsets.all(10),
            padding: const EdgeInsets.all(6),
            decoration: BoxDecoration(
              color: const Color(0xFFe94560).withOpacity(0.2),
              borderRadius: BorderRadius.circular(10),
            ),
            child: Icon(icon, color: const Color(0xFFe94560), size: 18),
          ),
          labelText: label,
          labelStyle: TextStyle(
            color: Colors.white.withOpacity(0.7),
            fontSize: 14,
          ),
          border: InputBorder.none,
          contentPadding: const EdgeInsets.symmetric(
            vertical: 16,
            horizontal: 16,
          ),
        ),
        style: const TextStyle(color: Colors.white, fontSize: 16),
        enabled: !_isLoading,
        onChanged: (_) => setState(() {}),
      ),
    );
  }

  Widget _buildDatePicker() {
    return Focus(
      focusNode: _datePickerFocusNode,
      onFocusChange: (hasFocus) {
        if (hasFocus) _selectDate();
        setState(() {});
      },
      onKey: (node, event) {
        if (event is RawKeyDownEvent &&
            event.logicalKey == LogicalKeyboardKey.select) {
          _selectDate();
          return KeyEventResult.handled;
        }
        return KeyEventResult.ignored;
      },
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 16),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          gradient: LinearGradient(
            colors: [
              Colors.white.withOpacity(0.1),
              Colors.white.withOpacity(0.05),
            ],
          ),
          border: Border.all(
            color:
                _datePickerFocusNode.hasFocus
                    ? const Color(0xFFe94560)
                    : Colors.white.withOpacity(0.2),
            width: 2,
          ),
          boxShadow:
              _datePickerFocusNode.hasFocus
                  ? [
                    BoxShadow(
                      color: const Color(0xFFe94560).withOpacity(0.3),
                      blurRadius: 15,
                    ),
                  ]
                  : null,
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Expanded(
              child: Text(
                _selectedBirthDate == null
                    ? "Tug'ilgan sana"
                    : DateFormat('dd MMMM yyyy').format(_selectedBirthDate!),
                style: TextStyle(
                  color:
                      _selectedBirthDate == null
                          ? Colors.white.withOpacity(0.5)
                          : Colors.white,
                  fontSize: 16,
                ),
              ),
            ),
            Container(
              padding: const EdgeInsets.all(6),
              decoration: BoxDecoration(
                color: const Color(0xFFe94560).withOpacity(0.2),
                borderRadius: BorderRadius.circular(10),
              ),
              child: const Icon(
                Icons.calendar_today,
                color: Color(0xFFe94560),
                size: 18,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Future<void> _selectDate() async {
    final pickedDate = await showDatePicker(
      context: context,
      initialDate: _selectedBirthDate ?? DateTime.now(),
      firstDate: DateTime(1900),
      lastDate: DateTime.now(),
      builder: (context, child) {
        return Theme(
          data: ThemeData.dark().copyWith(
            colorScheme: const ColorScheme.dark(
              primary: Color(0xFFe94560),
              onPrimary: Colors.white,
              surface: Color(0xFF1a1a2e),
              onSurface: Colors.white,
            ),
            dialogTheme: DialogTheme(
              backgroundColor: const Color(0xFF1a1a2e),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(20),
              ),
            ),
            textTheme: ThemeData.dark().textTheme.copyWith(
              bodyMedium: const TextStyle(fontSize: 18),
            ),
          ),
          child: child!,
        );
      },
    );
    if (pickedDate != null) {
      setState(() => _selectedBirthDate = pickedDate);
    }
  }

  Widget _buildGenderDropdown() {
    return AnimatedContainer(
      duration: const Duration(milliseconds: 200),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        gradient: LinearGradient(
          colors: [
            Colors.white.withOpacity(0.1),
            Colors.white.withOpacity(0.05),
          ],
        ),
        border: Border.all(
          color:
              _genderFocusNode.hasFocus
                  ? const Color(0xFFe94560)
                  : Colors.white.withOpacity(0.2),
          width: 2,
        ),
        boxShadow:
            _genderFocusNode.hasFocus
                ? [
                  BoxShadow(
                    color: const Color(0xFFe94560).withOpacity(0.3),
                    blurRadius: 15,
                  ),
                ]
                : null,
      ),
      child: DropdownButtonFormField<int>(
        focusNode: _genderFocusNode,
        value: _selectedGender,
        decoration: InputDecoration(
          prefixIcon: Container(
            margin: const EdgeInsets.all(10),
            padding: const EdgeInsets.all(6),
            decoration: BoxDecoration(
              color: const Color(0xFFe94560).withOpacity(0.2),
              borderRadius: BorderRadius.circular(10),
            ),
            child: const Icon(Icons.wc, color: Color(0xFFe94560), size: 18),
          ),
          labelText: "Jins",
          labelStyle: TextStyle(
            color: Colors.white.withOpacity(0.7),
            fontSize: 14,
          ),
          border: InputBorder.none,
          contentPadding: const EdgeInsets.symmetric(
            vertical: 16,
            horizontal: 16,
          ),
        ),
        style: const TextStyle(color: Colors.white, fontSize: 16),

        dropdownColor: const Color(0xFF1a1a2e),
        icon: const Icon(Icons.arrow_drop_down, color: Colors.white),
        items: const [
          DropdownMenuItem(
            value: 1,
            child: Text(
              "Erkak",
              style: TextStyle(fontSize: 18, color: Colors.white),
            ),
          ),
          DropdownMenuItem(
            value: 0,
            child: Text(
              "Ayol",
              style: TextStyle(fontSize: 18, color: Colors.white),
            ),
          ),
        ],
        onChanged:
            _isLoading
                ? null
                : (value) => setState(() => _selectedGender = value),
      ),
    );
  }

  Widget _tryLoadAssetImageWidget(String path, {double? height}) {
    try {
      return Image.asset(path, height: height);
    } catch (e) {
      debugPrint("Rasm yuklashda xatolik: $e");
      return Container(
        height: height,
        decoration: BoxDecoration(
          shape: BoxShape.circle,
          gradient: LinearGradient(
            colors: [
              const Color(0xFFe94560).withOpacity(0.3),
              const Color(0xFFf72585).withOpacity(0.3),
            ],
          ),
        ),
        child: const Center(
          child: Icon(Icons.tv, size: 50, color: Colors.white),
        ),
      );
    }
  }

  Future<void> _handleAction() async {
    if (_isCodeSent) {
      await _confirmCode();
    } else {
      await _sendPhone();
    }
  }

  Future<void> _sendPhone() async {
    final rawPhone = _phoneController.text.replaceAll(RegExp(r'[^0-9]'), '');
    final phone = "998$rawPhone";
    if (rawPhone.length != 9) {
      setState(() => _error = "To'liq raqam kiriting");
      return;
    }

    setState(() {
      _isLoading = true;
      _error = null;
    });

    final result = await ApiService.sendPhone(phone);

    if (!mounted) return;

    setState(() => _isLoading = false);

    if (result) {
      setState(() => _isCodeSent = true);
      _startTimer();
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (mounted && context.mounted) {
          FocusScope.of(context).requestFocus(_codeFocusNodes[0]);
          SystemChannels.textInput.invokeMethod('TextInput.show');
        }
      });
    } else {
      setState(() => _error = "SMS yuborishda xatolik yuz berdi");
    }
  }

  Future<void> _confirmCode() async {
    final code = _codeControllers.map((c) => c.text).join();
    if (code.length != 4) {
      setState(() => _error = "To'liq kod kiriting");
      return;
    }

    setState(() {
      _isLoading = true;
      _error = null;
    });

    final result = await ApiService.confirmSms(code);

    if (!mounted) return;

    setState(() => _isLoading = false);

    if (result['success']) {
      if (_isLoginMode) {
        _navigateToMainScreen();
      } else {
        await _registerUser();
      }
    } else if (result.containsKey('devices')) {
      _showDeviceSelectionDialog(result['devices']);
    } else {
      setState(() => _error = result['message'] ?? "Kod tasdiqlashda xatolik");
    }
  }

  Future<void> _showDeviceSelectionDialog(List<dynamic> devices) async {
    final prefs = await SharedPreferences.getInstance();
    final currentTokenId = prefs.getString('token_id');

    if (devices.length > 2) {
      setState(() => _isLoading = true);
      final tokenIdToKick =
          devices
              .firstWhere(
                (d) => d['id'].toString() != currentTokenId,
                orElse: () => devices.first,
              )['id']
              .toString();
      final kickResult = await ApiService.kickDevice(tokenIdToKick);

      if (!mounted) return;

      if (kickResult) {
        final confirmResult = await ApiService.confirmSms(
          _codeControllers.map((c) => c.text).join(),
        );
        setState(() => _isLoading = false);
        if (confirmResult['success']) {
          _isLoginMode ? _navigateToMainScreen() : await _registerUser();
        } else {
          setState(() => _error = "Tasdiqlashda xatolik");
        }
      } else {
        setState(() {
          _isLoading = false;
          _error = "Qurilma o'chirishda xatolik";
        });
      }
      return;
    }

    showDialog(
      context: context,
      builder:
          (context) => AlertDialog(
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(20),
            ),
            backgroundColor: const Color(0xFF1a1a2e),
            title: const Text(
              "Bir nechta qurilma topildi",
              style: TextStyle(fontSize: 22),
            ),
            content: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const Text(
                  "Bitta qurilmani o'chirib, davom eting:",
                  style: TextStyle(fontSize: 18),
                ),
                const SizedBox(height: 16),
                ...devices
                    .where((d) => d['id'].toString() != currentTokenId)
                    .map(
                      (device) => Container(
                        margin: const EdgeInsets.only(bottom: 12),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            colors: [
                              Colors.white.withOpacity(0.1),
                              Colors.white.withOpacity(0.05),
                            ],
                          ),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: Colors.white.withOpacity(0.2),
                          ),
                        ),
                        child: ListTile(
                          leading: const Icon(
                            Icons.devices,
                            color: Color(0xFFe94560),
                          ),
                          title: Text(
                            device['device_name'],
                            style: const TextStyle(
                              fontSize: 18,
                              color: Colors.white,
                            ),
                          ),
                          subtitle: Text(
                            "ID: ${device['id']}",
                            style: TextStyle(
                              fontSize: 14,
                              color: Colors.white.withOpacity(0.7),
                            ),
                          ),
                          onTap: () async {
                            Navigator.pop(context);
                            setState(() => _isLoading = true);
                            final kickResult = await ApiService.kickDevice(
                              device['id'].toString(),
                            );
                            if (kickResult) {
                              final confirmResult = await ApiService.confirmSms(
                                _codeControllers.map((c) => c.text).join(),
                              );
                              setState(() => _isLoading = false);
                              if (confirmResult['success']) {
                                _isLoginMode
                                    ? _navigateToMainScreen()
                                    : await _registerUser();
                              } else {
                                setState(() => _error = "Tasdiqlashda xatolik");
                              }
                            } else {
                              setState(() {
                                _isLoading = false;
                                _error = "Qurilma o'chirishda xatolik";
                              });
                            }
                          },
                        ),
                      ),
                    ),
              ],
            ),
          ),
    );
  }

  Future<void> _registerUser() async {
    final fullName = _fullNameController.text;
    final username = _usernameController.text;
    if (fullName.isEmpty ||
        username.isEmpty ||
        _selectedBirthDate == null ||
        _selectedGender == null) {
      setState(() => _error = "Barcha maydonlarni to'ldiring");
      return;
    }

    setState(() {
      _isLoading = true;
      _error = null;
    });

    final prefs = await SharedPreferences.getInstance();
    final token = prefs.getString('auth_token') ?? '';
    final birthDateUnix = (_selectedBirthDate!.millisecondsSinceEpoch ~/ 1000);

    final result = await ApiService.updateUser(
      fullName: fullName,
      username: username,
      birthDate: birthDateUnix,
      sex: _selectedGender!,
      token: token,
    );

    if (!mounted) return;

    setState(() => _isLoading = false);

    if (result) {
      _navigateToMainScreen();
    } else {
      setState(() => _error = "Ro'yxatdan o'tishda xatolik yuz berdi");
    }
  }

  void _navigateToMainScreen() {
    Navigator.pushReplacement(context, createSlideRoute(const MainScreen()));
  }

  void _resetFields() {
    _error = null;
    _phoneController.clear();
    for (var c in _codeControllers) c.clear();
    _fullNameController.clear();
    _usernameController.clear();
    _selectedBirthDate = null;
    _selectedGender = null;
    _isCodeSent = false;
    _remainingSeconds = 60;
    _canResend = false;
    _timer?.cancel();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (mounted && context.mounted) {
        FocusScope.of(context).requestFocus(_submitFocusNode);
      }
    });
  }

  @override
  void dispose() {
    _fadeController.dispose();
    _phoneFocusNode.removeListener(_onPhoneFieldFocusChanged);
    for (var node in [
      _phoneFocusNode,
      _submitFocusNode,
      _switchAuthModeFocusNode,
      ..._codeFocusNodes,
      _fullNameFocusNode,
      _usernameFocusNode,
      _datePickerFocusNode,
      _genderFocusNode,
      _phoneRawKeyFocusNode,
      _codeRawKeyFocusNode,
    ]) {
      node.dispose();
    }
    _phoneController.dispose();
    for (var c in _codeControllers) c.dispose();
    _fullNameController.dispose();
    _usernameController.dispose();
    _timer?.cancel();
    super.dispose();
  }
}
